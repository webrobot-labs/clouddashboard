"use strict";(()=>{var e={};e.id=876,e.ids=[876],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},87352:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>m,staticGenerationAsyncStorage:()=>x});var o={};r.r(o),r.d(o,{POST:()=>u});var a=r(73278),s=r(45002),i=r(54877),n=r(71309),p=r(47718),l=r(52422);let c=new p.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-09-30.acacia"});async function u(e){let t;let r=e.headers.get("stripe-signature"),o=process.env.STRIPE_WEBHOOK_SECRET;try{let a=await e.text();t=c.webhooks.constructEvent(a,r,o)}catch(e){return console.error("Errore nella verifica del webhook:",e.message),n.NextResponse.json({error:`Webhook Error: ${e.message}`},{status:400})}if("checkout.session.completed"===t.type){let e=t.data.object;console.log(`Pagamento riuscito per la sessione ${e.id}`),await d(e.metadata.userId,e.amount_total)}if("invoice.payment_succeeded"===t.type){let e=t.data.object;console.log(`Sottoscrizione pagata con successo per l'utente ${e.customer}`),await d(e.metadata.userId,e.amount_paid)}return n.NextResponse.json({received:!0})}let d=async(e,t)=>{try{let r=(await l.Z.get(`${process.env.LAGO_API_URL}/wallets`,{params:{external_customer_id:e,per_page:2,page:1},headers:{Authorization:`Bearer ${process.env.API_KEY}`,"Content-Type":"application/json"}})).data.wallets;if(r&&r.length>0){let e=r[0].id;console.log(`Wallet found for customer: ${e}, updating credits...`);let o=await l.Z.patch(`${process.env.LAGO_API_URL}/wallets/${e}`,{wallet:{paid_credits:t}},{headers:{Authorization:`Bearer ${process.env.API_KEY}`,"Content-Type":"application/json"}});console.log("Wallet updated successfully:",o.data)}else{console.log("No wallet found, creating a new one...");let r=await l.Z.post(`${process.env.LAGO_API_URL}/wallets`,{wallet:{name:"Prepaid",rate_amount:"1",paid_credits:t.toString(),granted_credits:"0.0",currency:"USD",expiration_at:"2025-12-31",external_customer_id:e}},{headers:{Authorization:`Bearer ${process.env.API_KEY}`,"Content-Type":"application/json"}});console.log("Wallet created successfully:",r.data)}}catch(e){console.error("Error creating or updating wallet:",e)}},h=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/stripe-webhook/route",pathname:"/api/stripe-webhook",filename:"route",bundlePath:"app/api/stripe-webhook/route"},resolvedPagePath:"/home/roger/github/clouddashboard/app/api/stripe-webhook/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:x,serverHooks:m}=h,_="/api/stripe-webhook/route";function w(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:x})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[379,833,4],()=>r(87352));module.exports=o})();